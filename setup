#!/usr/bin/env python3

import os
import shutil
import subprocess
from argparse import ArgumentParser
from contextlib import contextmanager
from enum import Enum
from pathlib import Path
from typing import Any, Generator


class TerminalCode(Enum):
    RESET = "\033[0m"
    BOLD = "\033[1m"
    UNDERLIZE = "\033[4m"
    RED = "\033[91m"
    GREEN = "\033[92m"
    YELLOW = "\033[93m"


def termcode(s: str, color: TerminalCode, *args: TerminalCode) -> str:
    if args:
        s = termcode(s, *args)
    return f"{color.value}{s}{TerminalCode.RESET.value}"


def check_call(cmd: str, **kwargs: Any) -> None:
    print(">", termcode(cmd, TerminalCode.BOLD))
    kwargs["shell"] = True
    kwargs["stderr"] = subprocess.STDOUT
    try:
        res = subprocess.check_output(cmd, **kwargs)
        if res:
            print(res.decode("utf-8").strip())
    except subprocess.CalledProcessError as err:
        print(err.output.decode("utf-8").strip())
        raise


def stow(path: Path) -> None:
    check_call(f"stow -t {Path.home()} -vS {path!s}")


def print_command(cmd: str) -> None:
    which = shutil.which(cmd)
    status = termcode("OK", TerminalCode.GREEN)
    if which is None:
        status = termcode("FAIL", TerminalCode.RED)
    print(status, cmd, "->", shutil.which(cmd))


@contextmanager
def pushd(path: Path) -> Generator[Path, None, None]:
    previous_path = Path(os.getcwd())
    os.chdir(path)
    try:
        yield path
    finally:
        os.chdir(previous_path)


class InstallTarget(Enum):
    CHECKHEALTH = "checkhealth"
    CLI = "cli"
    GUI = "gui"
    WSL = "wsl"
    WSL_WORK = "wsl-work"

    def __str__(self) -> str:
        return self.value


def guess_target() -> list[InstallTarget]:
    targets = [InstallTarget.CHECKHEALTH, InstallTarget.CLI]
    if shutil.which("wsl.exe"):
        targets = [*targets, InstallTarget.WSL]
        if Path(Path.home(), ".work").exists():
            targets = [*targets, InstallTarget.WSL_WORK]
    elif shutil.which("pacman"):
        targets = [*targets, InstallTarget.GUI]
    return targets


if __name__ == "__main__":
    parser = ArgumentParser()
    parser.add_argument("targets", type=InstallTarget, nargs="*", choices=list(InstallTarget))
    args = parser.parse_args()
    targets = args.targets
    if not targets:
        targets = guess_target()

    with pushd(Path(__file__).parent):
        Path(Path.home(), ".config").mkdir(parents=True, exist_ok=True)
        Path(Path.home(), ".local", "bin").mkdir(parents=True, exist_ok=True)
        Path(Path.home(), ".virtualenvs").mkdir(parents=True, exist_ok=True)

        if InstallTarget.CLI in targets:
            stow(Path(".", "cli"))
            if shutil.which("asdf"):
                check_call("asdf plugin add python")
                check_call("asdf plugin update --all")
            if shutil.which("vf"):
                check_call("vf install auto_activation global_requirements environment")

        if InstallTarget.GUI in targets:
            stow(Path(".", "gui"))

        if InstallTarget.WSL in targets:
            stow(Path(".", "wsl"))
            if shutil.which("fish"):
                check_call("fish -c 'set -Ux AUTOSTART_TMUX 1'")
            # install and setup brew
            if shutil.which("brew") is None:
                check_call("curl -sL https://raw.githubusercontent.com/Homebrew/install/master/install.sh | bash -s")
            check_call("brew update")
            check_call("brew bundle --upgrade")
            brew_prefix = subprocess.check_output("brew --prefix", shell=True).decode("utf-8").strip()
            fzf_install = Path(brew_prefix, "opt", "fzf", "install")
            check_call(f"{fzf_install} --key-bindings --completion --no-update-rc --xdg")

        if InstallTarget.WSL_WORK in targets:
            stow(Path(".", "wsl-work"))

        if InstallTarget.CHECKHEALTH in targets:
            print_command("asdf")
            print_command("bash-language-server")
            print_command("bat")
            print_command("brew")
            print_command("carapace")
            print_command("cargo")
            print_command("clangd")
            print_command("fd")
            print_command("fish")
            print_command("fzf")
            print_command("git-lfs")
            print_command("go")
            print_command("groovy-language-server")
            print_command("lua-language-server")
            print_command("nvim")
            print_command("rg")
            print_command("rustup")
            print_command("stow")
            print_command("tmux")
            print_command("vf")
            print_command("vscode-json-language-server")
            print_command("yaml-language-server")
